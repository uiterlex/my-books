<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Books list</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 2rem;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            color: #1a1a1a;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .stats {
            color: #666;
        }

        .user-email {
            font-size: 0.85rem;
            color: #666;
            margin-right: 0.5rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #3730a3;
            color: white;
        }

        .btn-primary:hover {
            background: #2e2892;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-danger {
            background: #fee2e2;
            color: #dc2626;
        }

        .btn-danger:hover {
            background: #fecaca;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .btn-google {
            background: white;
            border: 1px solid #d1d5db;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-google:hover {
            background: #f9fafb;
        }

        .btn-google img {
            width: 18px;
            height: 18px;
        }

        .book-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .book-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .book-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .book-info {
            flex: 1;
        }

        .book-actions {
            display: flex;
            gap: 0.5rem;
        }

        .book-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.25rem;
        }

        .book-author {
            color: #666;
            margin-bottom: 0.75rem;
        }

        .book-meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
        }

        .book-meta span {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: #555;
        }

        .stars {
            color: #f59e0b;
            letter-spacing: 1px;
        }

        .series {
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 2rem;
        }

        .hidden {
            display: none !important;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3730a3;
            box-shadow: 0 0 0 3px rgba(55, 48, 163, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .confirm-message {
            margin-bottom: 1.5rem;
            color: #374151;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .error {
            text-align: center;
            color: #dc2626;
            padding: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1>ðŸ“š My Books list</h1>
                <div class="header-actions">
                    <!-- Logged out state -->
                    <button class="btn btn-google" id="login-btn" onclick="signIn()">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                        Sign in
                    </button>
                    
                    <!-- Logged in state -->
                    <span class="user-email hidden" id="user-email"></span>
                    <button class="btn btn-primary hidden" id="add-btn" onclick="openAddModal()">+ Add Book</button>
                    <button class="btn btn-secondary btn-small hidden" id="logout-btn" onclick="signOut()">Sign out</button>
                </div>
            </div>
            <p class="stats" id="stats">Loading...</p>
        </header>

        <div class="book-list" id="book-list">
            <p class="loading">Loading books...</p>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal-overlay" id="book-modal">
        <div class="modal">
            <h2 id="modal-title">Add Book</h2>
            <form id="book-form" onsubmit="saveBook(event)">
                <input type="hidden" id="book-id">
                
                <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" required>
                </div>
                
                <div class="form-group">
                    <label for="author">Author *</label>
                    <input type="text" id="author" required>
                </div>
                
                <div class="form-group">
                    <label for="pages">Pages *</label>
                    <input type="number" id="pages" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="rating">Rating *</label>
                    <select id="rating" required>
                        <option value="5">â˜…â˜…â˜…â˜…â˜… (5)</option>
                        <option value="4">â˜…â˜…â˜…â˜…â˜† (4)</option>
                        <option value="3">â˜…â˜…â˜…â˜†â˜† (3)</option>
                        <option value="2">â˜…â˜…â˜†â˜†â˜† (2)</option>
                        <option value="1">â˜…â˜†â˜†â˜†â˜† (1)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="series">Series (optional)</label>
                    <input type="text" id="series">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <h2>Delete Book</h2>
            <p class="confirm-message" id="confirm-message">Are you sure you want to delete this book?</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, signOut as firebaseSignOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC7oDuArIH_LMQbSyKE8k1g0m3n_fa1NH8",
            authDomain: "my-books-4ef15.firebaseapp.com",
            projectId: "my-books-4ef15",
            storageBucket: "my-books-4ef15.firebasestorage.app",
            messagingSenderId: "920189621468",
            appId: "1:920189621468:web:101a4c439e8e3cbd18d019"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let books = [];
        let bookToDelete = null;
        let currentUser = null;

        // Auth functions
        window.signIn = async function() {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Sign in failed. Please try again.');
            }
        };

        window.signOut = async function() {
            try {
                await firebaseSignOut(auth);
            } catch (error) {
                console.error('Sign out error:', error);
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateAuthUI();
            renderBooks();
        });

        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const addBtn = document.getElementById('add-btn');
            const userEmail = document.getElementById('user-email');

            if (currentUser) {
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                addBtn.classList.remove('hidden');
                userEmail.classList.remove('hidden');
                userEmail.textContent = currentUser.email;
            } else {
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                addBtn.classList.add('hidden');
                userEmail.classList.add('hidden');
            }
        }

        // Book rendering
        function renderStars(rating) {
            return 'â˜…'.repeat(rating) + 'â˜†'.repeat(5 - rating);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderBook(book) {
            const actionsHtml = currentUser ? `
                <div class="book-actions">
                    <button class="btn btn-secondary btn-small" onclick="openEditModal('${book.id}')">Edit</button>
                    <button class="btn btn-danger btn-small" onclick="openDeleteConfirm('${book.id}')">Delete</button>
                </div>
            ` : '';

            return `
                <article class="book-card">
                    <div class="book-header">
                        <div class="book-info">
                            <h2 class="book-title">${escapeHtml(book.title)}</h2>
                            <p class="book-author">${escapeHtml(book.author)}</p>
                        </div>
                        ${actionsHtml}
                    </div>
                    <div class="book-meta">
                        <span class="stars">${renderStars(book.rating)}</span>
                        <span>ðŸ“„ ${book.pages} pages</span>
                        ${book.series ? `<span class="series">${escapeHtml(book.series)}</span>` : ''}
                    </div>
                </article>
            `;
        }

        function updateStats() {
            const totalBooks = books.length;
            const totalPages = books.reduce((sum, book) => sum + (book.pages || 0), 0);
            document.getElementById('stats').textContent = 
                `${totalBooks} book${totalBooks !== 1 ? 's' : ''} read Â· ${totalPages.toLocaleString()} pages`;
        }

        function renderBooks() {
            const bookList = document.getElementById('book-list');
            if (books.length === 0) {
                bookList.innerHTML = '<p class="empty-state">No books yet.</p>';
            } else {
                bookList.innerHTML = books.map(renderBook).join('');
            }
            updateStats();
        }

        // Real-time listener
        const booksQuery = query(collection(db, 'books'), orderBy('title'));
        onSnapshot(booksQuery, (snapshot) => {
            books = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            renderBooks();
        }, (error) => {
            console.error('Error loading books:', error);
            document.getElementById('book-list').innerHTML = 
                '<p class="error">Failed to load books. Please refresh the page.</p>';
        });

        // Modal functions
        window.openAddModal = function() {
            document.getElementById('modal-title').textContent = 'Add Book';
            document.getElementById('book-form').reset();
            document.getElementById('book-id').value = '';
            document.getElementById('book-modal').classList.add('active');
        };

        window.openEditModal = function(id) {
            const book = books.find(b => b.id === id);
            if (!book) return;

            document.getElementById('modal-title').textContent = 'Edit Book';
            document.getElementById('book-id').value = book.id;
            document.getElementById('title').value = book.title;
            document.getElementById('author').value = book.author;
            document.getElementById('pages').value = book.pages;
            document.getElementById('rating').value = book.rating;
            document.getElementById('series').value = book.series || '';
            document.getElementById('book-modal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('book-modal').classList.remove('active');
        };

        window.saveBook = async function(event) {
            event.preventDefault();
            if (!currentUser) return;

            const id = document.getElementById('book-id').value;
            const bookData = {
                title: document.getElementById('title').value.trim(),
                author: document.getElementById('author').value.trim(),
                pages: parseInt(document.getElementById('pages').value),
                rating: parseInt(document.getElementById('rating').value),
                series: document.getElementById('series').value.trim() || null
            };

            try {
                if (id) {
                    await updateDoc(doc(db, 'books', id), bookData);
                } else {
                    await addDoc(collection(db, 'books'), bookData);
                }
                closeModal();
            } catch (error) {
                console.error('Error saving book:', error);
                alert('Failed to save book. Please try again.');
            }
        };

        window.openDeleteConfirm = function(id) {
            const book = books.find(b => b.id === id);
            if (!book) return;

            bookToDelete = id;
            document.getElementById('confirm-message').textContent = 
                `Are you sure you want to delete "${book.title}"?`;
            document.getElementById('confirm-modal').classList.add('active');
        };

        window.closeConfirmModal = function() {
            document.getElementById('confirm-modal').classList.remove('active');
            bookToDelete = null;
        };

        window.confirmDelete = async function() {
            if (!bookToDelete || !currentUser) return;

            try {
                await deleteDoc(doc(db, 'books', bookToDelete));
                closeConfirmModal();
            } catch (error) {
                console.error('Error deleting book:', error);
                alert('Failed to delete book. Please try again.');
            }
        };

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                    bookToDelete = null;
                }
            });
        });

        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeConfirmModal();
            }
        });
    </script>
</body>
</html>
