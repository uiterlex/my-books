<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Book Collection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            color: #1a1a1a;
        }

        .stats {
            color: #666;
            margin-top: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .add-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: none;
        }

        .add-btn:hover {
            background: #059669;
        }

        .auth-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .auth-btn:hover {
            background: #4f46e5;
        }

        .auth-btn.sign-out {
            background: #64748b;
        }

        .auth-btn.sign-out:hover {
            background: #475569;
        }

        /* Controls Section */
        .controls {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .toggle-btn {
            background: #e5e7eb;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #555;
        }

        .toggle-btn:hover {
            background: #d1d5db;
        }

        .toggle-btn.active {
            background: #bbf7d0;
            color: #166534;
        }

        .toggle-btn.active:hover {
            background: #a7f3d0;
        }

        .control-section {
            margin-bottom: 1.25rem;
        }

        .control-section:last-child {
            margin-bottom: 0;
        }

        .control-section h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-group label {
            font-size: 0.8rem;
            color: #555;
            font-weight: 500;
        }

        .filter-group input,
        .filter-group select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .filter-row {
            display: flex;
            gap: 0.5rem;
        }

        .filter-row select {
            width: 70px;
        }

        .filter-row input {
            flex: 1;
        }

        .sort-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .sort-row select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            min-width: 200px;
        }

        .sort-row select:focus {
            outline: none;
            border-color: #6366f1;
        }

        .reverse-toggle {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.9rem;
            color: #555;
            cursor: pointer;
        }

        .reverse-toggle input {
            cursor: pointer;
            width: auto;
        }

        .btn-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .apply-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .apply-btn:hover {
            background: #4f46e5;
        }

        .clear-btn {
            background: #f3f4f6;
            color: #555;
            border: 1px solid #ddd;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .clear-btn:hover {
            background: #e5e7eb;
        }

        .results-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
        }

        /* Book List */
        .book-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .book-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .book-cover {
            width: 100px;
            min-height: 150px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .book-info {
            padding: 1.25rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .book-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .book-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.25rem;
        }

        .book-author {
            color: #666;
        }

        .book-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .edit-btn, .delete-btn {
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .edit-btn {
            background: #e0e7ff;
            color: #3730a3;
        }

        .edit-btn:hover {
            background: #c7d2fe;
        }

        .delete-btn {
            background: #fee2e2;
            color: #b91c1c;
        }

        .delete-btn:hover {
            background: #fecaca;
        }

        .book-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .book-meta span {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: #555;
        }

        .stars {
            color: #f59e0b;
            letter-spacing: 1px;
        }

        .series {
            color: #666;
            font-style: italic;
        }

        .category {
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .category-thriller {
            background: #fee2e2;
            color: #b91c1c;
        }

        .category-detective {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .category-other {
            background: #f3f4f6;
            color: #4b5563;
        }

        .book-category-corner {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
        }

        .book-dates {
            font-size: 0.85rem;
            color: #888;
            margin-top: 0.25rem;
        }

        .preview-text {
            font-size: 0.85rem;
            color: #666;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .preview-text:hover {
            color: #333;
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: #e5e7eb;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: 600;
            color: #666;
        }

        .plot-btn {
            background: #f3f4f6;
            border: 1px solid #ddd;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            color: #555;
        }

        .plot-btn:hover {
            background: #e5e7eb;
        }

        .loading-text {
            text-align: center;
            color: #666;
            padding: 2rem;
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-header h3 {
            font-size: 1.25rem;
            color: #1a1a1a;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            color: #555;
            line-height: 1.7;
            white-space: pre-wrap;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
            color: #555;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .form-actions button {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .cancel-btn {
            background: #f3f4f6;
            border: 1px solid #ddd;
            color: #555;
        }

        .save-btn {
            background: #10b981;
            border: none;
            color: white;
        }

        .save-btn:hover {
            background: #059669;
        }

        .confirm-delete-btn {
            background: #ef4444;
            border: none;
            color: white;
        }

        .confirm-delete-btn:hover {
            background: #dc2626;
        }

        /* Cover upload */
        .cover-preview {
            max-width: 100px;
            max-height: 150px;
            margin-top: 0.5rem;
            border-radius: 4px;
        }

        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }

            header {
                flex-direction: column;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .sort-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .sort-row select {
                width: 100%;
            }

            .book-card {
                flex-direction: column;
            }

            .book-cover {
                width: 100%;
                height: 200px;
            }

            .book-header {
                flex-direction: column;
            }

            .book-actions {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>ðŸ“š My Book Collection</h1>
                <p class="stats" id="stats">Loading...</p>
            </div>
            <div class="header-actions">
                <button class="add-btn" id="addBtn">+ Add Book</button>
                <button class="toggle-btn" id="toggleControls">Show Filter & Sort</button>
                <button class="auth-btn" id="signInBtn">Sign In</button>
                <button class="auth-btn sign-out" id="signOutBtn" style="display:none;">Sign Out</button>
            </div>
        </header>

        <!-- Filter & Sort Controls -->
        <div class="controls" id="controlsPanel" style="display: none;">
            <div class="control-section">
                <h3>Filter</h3>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="filterTitle">Title</label>
                            <input type="text" id="filterTitle" placeholder="Search title...">
                        </div>
                        <div class="filter-group">
                            <label for="filterAuthor">Author</label>
                            <input type="text" id="filterAuthor" placeholder="Search author...">
                        </div>
                        <div class="filter-group">
                            <label for="filterSeries">Series</label>
                            <input type="text" id="filterSeries" placeholder="Search series...">
                        </div>
                        <div class="filter-group">
                            <label for="filterCategory">Category</label>
                            <select id="filterCategory">
                                <option value="">All categories</option>
                                <option value="thriller">Thriller</option>
                                <option value="detective">Detective</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Rating</label>
                            <div class="filter-row">
                                <select id="filterRatingOp">
                                    <option value="">Any</option>
                                    <option value="=">=</option>
                                    <option value=">=">â‰¥</option>
                                    <option value="<=">â‰¤</option>
                                </select>
                                <select id="filterRatingVal">
                                    <option value="">-</option>
                                    <option value="1">â˜…</option>
                                    <option value="2">â˜…â˜…</option>
                                    <option value="3">â˜…â˜…â˜…</option>
                                    <option value="4">â˜…â˜…â˜…â˜…</option>
                                    <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>Date Read</label>
                            <div class="filter-row">
                                <select id="filterDateOp">
                                    <option value="">Any</option>
                                    <option value="=">=</option>
                                    <option value=">=">â‰¥</option>
                                    <option value="<=">â‰¤</option>
                                </select>
                                <input type="month" id="filterDateVal">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Sort</h3>
                    <div class="sort-row">
                        <select id="sortBy">
                            <option value="dateRead">Date read</option>
                            <option value="category-author-firstEdition">Category â†’ Author â†’ First edition</option>
                            <option value="author-series-firstEdition">Author â†’ Series â†’ First edition</option>
                            <option value="rating-author-series-firstEdition">Rating â†’ Author â†’ Series â†’ First edition</option>
                        </select>
                        <label class="reverse-toggle">
                            <input type="checkbox" id="sortReverse">
                            Reverse order
                        </label>
                    </div>
                </div>

                <div class="btn-row">
                    <button class="apply-btn" id="applyBtn">Apply</button>
                    <button class="clear-btn" id="clearBtn">Clear</button>
                </div>
        </div>

        <p class="results-info" id="resultsInfo"></p>
        <div class="book-list" id="bookList">
            <p class="loading-text">Loading books...</p>
        </div>
    </div>

    <!-- Text Modal (for Preview/Plot) -->
    <div class="modal" id="textModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="textModalTitle">Title</h3>
                <button class="close-btn" onclick="closeTextModal()">&times;</button>
            </div>
            <div class="modal-body" id="textModalContent"></div>
        </div>
    </div>

    <!-- Add/Edit Book Modal -->
    <div class="modal" id="bookModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="bookModalTitle">Add Book</h3>
                <button class="close-btn" onclick="closeBookModal()">&times;</button>
            </div>
            <form id="bookForm">
                <input type="hidden" id="bookId">
                <div class="form-group">
                    <label for="bookTitle">Title *</label>
                    <input type="text" id="bookTitle" required>
                </div>
                <div class="form-group">
                    <label for="bookAuthor">Author *</label>
                    <input type="text" id="bookAuthor" required>
                </div>
                <div class="form-group">
                    <label for="bookPages">Pages</label>
                    <input type="number" id="bookPages">
                </div>
                <div class="form-group">
                    <label for="bookRating">Rating</label>
                    <select id="bookRating">
                        <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
                        <option value="4">â˜…â˜…â˜…â˜…â˜†</option>
                        <option value="3">â˜…â˜…â˜…â˜†â˜†</option>
                        <option value="2">â˜…â˜…â˜†â˜†â˜†</option>
                        <option value="1">â˜…â˜†â˜†â˜†â˜†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bookSeries">Series</label>
                    <input type="text" id="bookSeries">
                </div>
                <div class="form-group">
                    <label for="bookCategory">Category</label>
                    <select id="bookCategory">
                        <option value="">-- Select --</option>
                        <option value="thriller">Thriller</option>
                        <option value="detective">Detective</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bookFirstEdition">First Edition (year)</label>
                    <input type="text" id="bookFirstEdition" maxlength="4" placeholder="YYYY">
                </div>
                <div class="form-group">
                    <label for="bookDateRead">Date Read</label>
                    <input type="month" id="bookDateRead">
                </div>
                <div class="form-group">
                    <label for="bookPreview">Preview</label>
                    <textarea id="bookPreview" placeholder="First lines of the book..."></textarea>
                </div>
                <div class="form-group">
                    <label for="bookPlot">Plot</label>
                    <textarea id="bookPlot" placeholder="Book summary..."></textarea>
                </div>
                <div class="form-group">
                    <label for="bookCover">Cover Image</label>
                    <input type="file" id="bookCover" accept="image/*">
                    <img id="coverPreview" class="cover-preview" style="display:none;">
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="closeBookModal()">Cancel</button>
                    <button type="submit" class="save-btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Book</h3>
                <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
            </div>
            <p>Are you sure you want to delete this book?</p>
            <div class="form-actions">
                <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
                <button class="confirm-delete-btn" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyC7oDuArIH_LMQbSyKE8k1g0m3n_fa1NH8",
            authDomain: "my-books-4ef15.firebaseapp.com",
            projectId: "my-books-4ef15",
            storageBucket: "my-books-4ef15.firebasestorage.app",
            messagingSenderId: "920189621468",
            appId: "1:920189621468:web:101a4c439e8e3cbd18d019"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();

        // Owner email
        const OWNER_EMAIL = "uiterlex@gmail.com";

        // State
        let allBooks = [];
        let filteredBooks = [];
        let isOwner = false;
        let currentUser = null;
        let deleteBookId = null;

        // DOM elements
        const statsEl = document.getElementById('stats');
        const bookListEl = document.getElementById('bookList');
        const resultsInfoEl = document.getElementById('resultsInfo');
        const addBtn = document.getElementById('addBtn');
        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');

        // Filter/Sort elements
        const toggleBtn = document.getElementById('toggleControls');
        const controlsPanel = document.getElementById('controlsPanel');
        const applyBtn = document.getElementById('applyBtn');
        const clearBtn = document.getElementById('clearBtn');
        const filterTitle = document.getElementById('filterTitle');
        const filterAuthor = document.getElementById('filterAuthor');
        const filterSeries = document.getElementById('filterSeries');
        const filterCategory = document.getElementById('filterCategory');
        const filterRatingOp = document.getElementById('filterRatingOp');
        const filterRatingVal = document.getElementById('filterRatingVal');
        const filterDateOp = document.getElementById('filterDateOp');
        const filterDateVal = document.getElementById('filterDateVal');
        const sortByEl = document.getElementById('sortBy');
        const sortReverseEl = document.getElementById('sortReverse');

        // Modal elements
        const textModal = document.getElementById('textModal');
        const bookModal = document.getElementById('bookModal');
        const deleteModal = document.getElementById('deleteModal');
        const bookForm = document.getElementById('bookForm');

        // ============================================
        // FILTER & SORT FUNCTIONALITY
        // ============================================

        toggleBtn.addEventListener('click', () => {
            const isVisible = controlsPanel.style.display !== 'none';
            controlsPanel.style.display = isVisible ? 'none' : 'block';
            toggleBtn.textContent = isVisible ? 'Show Filter & Sort' : 'Hide Filter & Sort';
        });

        applyBtn.addEventListener('click', applyFiltersAndSort);

        clearBtn.addEventListener('click', () => {
            filterTitle.value = '';
            filterAuthor.value = '';
            filterSeries.value = '';
            filterCategory.value = '';
            filterRatingOp.value = '';
            filterRatingVal.value = '';
            filterDateOp.value = '';
            filterDateVal.value = '';
            sortByEl.value = 'dateRead';
            sortReverseEl.checked = false;
            applyFiltersAndSort();
        });

        function applyFiltersAndSort() {
            filteredBooks = allBooks.filter(book => {
                if (filterTitle.value) {
                    if (!book.title || !book.title.toLowerCase().includes(filterTitle.value.toLowerCase())) {
                        return false;
                    }
                }
                if (filterAuthor.value) {
                    if (!book.author || !book.author.toLowerCase().includes(filterAuthor.value.toLowerCase())) {
                        return false;
                    }
                }
                if (filterSeries.value) {
                    if (!book.series || !book.series.toLowerCase().includes(filterSeries.value.toLowerCase())) {
                        return false;
                    }
                }
                if (filterCategory.value) {
                    if (book.category !== filterCategory.value) {
                        return false;
                    }
                }
                if (filterRatingOp.value && filterRatingVal.value) {
                    const bookRating = book.rating || 0;
                    const filterVal = parseInt(filterRatingVal.value);
                    if (!compareValues(bookRating, filterRatingOp.value, filterVal)) {
                        return false;
                    }
                }
                if (filterDateOp.value && filterDateVal.value) {
                    const bookDate = book.dateRead || '';
                    if (!bookDate || !compareDates(bookDate, filterDateOp.value, filterDateVal.value)) {
                        return false;
                    }
                }
                return true;
            });

            sortBooks();
            renderBooks();
            updateResultsInfo();
        }

        function compareValues(val1, operator, val2) {
            switch (operator) {
                case '=': return val1 === val2;
                case '>=': return val1 >= val2;
                case '<=': return val1 <= val2;
                default: return true;
            }
        }

        function compareDates(date1, operator, date2) {
            const d1 = date1.substring(0, 7);
            const d2 = date2.substring(0, 7);
            switch (operator) {
                case '=': return d1 === d2;
                case '>=': return d1 >= d2;
                case '<=': return d1 <= d2;
                default: return true;
            }
        }

        function sortBooks() {
            const sortType = sortByEl.value;
            const reverse = sortReverseEl.checked;

            filteredBooks.sort((a, b) => {
                let result = 0;
                switch (sortType) {
                    case 'dateRead':
                        result = (b.dateRead || '').localeCompare(a.dateRead || '');
                        break;
                    case 'category-author-firstEdition':
                        result = (a.category || '').localeCompare(b.category || '') ||
                                 (a.author || '').localeCompare(b.author || '') ||
                                 (a.firstEdition || '').localeCompare(b.firstEdition || '');
                        break;
                    case 'author-series-firstEdition':
                        result = (a.author || '').localeCompare(b.author || '') ||
                                 (a.series || '').localeCompare(b.series || '') ||
                                 (a.firstEdition || '').localeCompare(b.firstEdition || '');
                        break;
                    case 'rating-author-series-firstEdition':
                        result = (b.rating || 0) - (a.rating || 0) ||
                                 (a.author || '').localeCompare(b.author || '') ||
                                 (a.series || '').localeCompare(b.series || '') ||
                                 (a.firstEdition || '').localeCompare(b.firstEdition || '');
                        break;
                }
                return reverse ? -result : result;
            });
        }

        function updateResultsInfo() {
            const hasFilters = filterTitle.value || filterAuthor.value || filterSeries.value || 
                              filterCategory.value || (filterRatingOp.value && filterRatingVal.value) ||
                              (filterDateOp.value && filterDateVal.value);
            const hasCustomSort = sortByEl.value !== 'dateRead' || sortReverseEl.checked;
            const isActive = hasFilters || hasCustomSort;
            
            // Update button active state (pastel green when filter/sort active)
            if (isActive) {
                toggleBtn.classList.add('active');
            } else {
                toggleBtn.classList.remove('active');
            }
            
            if (hasFilters) {
                resultsInfoEl.textContent = `Showing ${filteredBooks.length} of ${allBooks.length} books`;
            } else {
                resultsInfoEl.textContent = '';
            }
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================

        function renderStars(rating) {
            const filled = rating || 0;
            const empty = 5 - filled;
            return 'â˜…'.repeat(filled) + 'â˜†'.repeat(empty);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length < 2) return dateStr;
            const [year, month] = parts;
            const monthNum = parseInt(month);
            if (isNaN(monthNum) || monthNum < 1 || monthNum > 12) return dateStr;
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[monthNum - 1]} ${year}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function renderBooks() {
            if (filteredBooks.length === 0) {
                if (allBooks.length === 0) {
                    bookListEl.innerHTML = '<p class="loading-text">No books yet. Add your first book!</p>';
                } else {
                    bookListEl.innerHTML = '<div class="no-results">No books match your filters.</div>';
                }
                return;
            }

            bookListEl.innerHTML = filteredBooks.map(book => `
                <article class="book-card">
                    ${book.coverUrl 
                        ? `<img src="${book.coverUrl}" alt="${escapeHtml(book.title)}" class="book-cover">`
                        : ''
                    }
                    ${book.category ? `<span class="book-category-corner category category-${book.category}">${book.category}</span>` : ''}
                    <div class="book-info">
                        <div class="book-header">
                            <div>
                                <h2 class="book-title">${escapeHtml(book.title)}</h2>
                                <p class="book-author">${escapeHtml(book.author)}</p>
                            </div>
                            ${isOwner ? `
                                <div class="book-actions">
                                    <button class="edit-btn" onclick="window.editBook('${book.id}')">Edit</button>
                                    <button class="delete-btn" onclick="window.confirmDelete('${book.id}')">Delete</button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="book-meta">
                            <span class="stars">${renderStars(book.rating)}</span>
                            ${book.pages ? `<span>ðŸ“„ ${book.pages} pages</span>` : ''}
                            ${book.series ? `<span class="series">Series: ${escapeHtml(book.series)}</span>` : ''}
                        </div>
                        ${book.preview ? `
                            <div class="preview-text" onclick="window.showText('Preview', \`${book.preview.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`)">
                                ${book.preview.length > 30 ? escapeHtml(book.preview.substring(0, 30)) + '...' : escapeHtml(book.preview)}
                                <span class="info-icon">i</span>
                            </div>
                        ` : ''}
                        ${book.plot ? `<button class="plot-btn" onclick="window.showText('Plot', \`${book.plot.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`)">Plot</button>` : ''}
                        ${book.dateRead || book.firstEdition ? `
                            <p class="book-dates">
                                ${book.dateRead ? `Read: ${formatDate(book.dateRead)}` : ''}
                                ${book.dateRead && book.firstEdition ? ' Â· ' : ''}
                                ${book.firstEdition ? `First edition: ${book.firstEdition}` : ''}
                            </p>
                        ` : ''}
                    </div>
                </article>
            `).join('');
        }

        function updateStats() {
            const totalBooks = allBooks.length;
            const totalPages = allBooks.reduce((sum, book) => sum + (parseInt(book.pages) || 0), 0);
            statsEl.textContent = `${totalBooks} book${totalBooks !== 1 ? 's' : ''} Â· ${totalPages.toLocaleString()} pages`;
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================

        window.showText = function(title, content) {
            document.getElementById('textModalTitle').textContent = title;
            document.getElementById('textModalContent').textContent = content;
            textModal.classList.add('show');
        };

        window.closeTextModal = function() {
            textModal.classList.remove('show');
        };

        window.closeBookModal = function() {
            bookModal.classList.remove('show');
            bookForm.reset();
            document.getElementById('bookId').value = '';
            document.getElementById('coverPreview').style.display = 'none';
        };

        window.closeDeleteModal = function() {
            deleteModal.classList.remove('show');
            deleteBookId = null;
        };

        // ============================================
        // BOOK CRUD OPERATIONS
        // ============================================

        addBtn.addEventListener('click', () => {
            document.getElementById('bookModalTitle').textContent = 'Add Book';
            document.getElementById('bookId').value = '';
            bookForm.reset();
            document.getElementById('coverPreview').style.display = 'none';
            bookModal.classList.add('show');
        });

        window.editBook = function(id) {
            const book = allBooks.find(b => b.id === id);
            if (!book) return;

            document.getElementById('bookModalTitle').textContent = 'Edit Book';
            document.getElementById('bookId').value = id;
            document.getElementById('bookTitle').value = book.title || '';
            document.getElementById('bookAuthor').value = book.author || '';
            document.getElementById('bookPages').value = book.pages || '';
            document.getElementById('bookRating').value = book.rating || 5;
            document.getElementById('bookSeries').value = book.series || '';
            document.getElementById('bookCategory').value = book.category || '';
            document.getElementById('bookFirstEdition').value = book.firstEdition || '';
            document.getElementById('bookDateRead').value = book.dateRead || '';
            document.getElementById('bookPreview').value = book.preview || '';
            document.getElementById('bookPlot').value = book.plot || '';

            const preview = document.getElementById('coverPreview');
            if (book.coverUrl) {
                preview.src = book.coverUrl;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }

            bookModal.classList.add('show');
        };

        window.confirmDelete = function(id) {
            deleteBookId = id;
            deleteModal.classList.add('show');
        };

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!deleteBookId) return;

            try {
                const book = allBooks.find(b => b.id === deleteBookId);
                if (book && book.coverUrl) {
                    try {
                        const coverRef = ref(storage, `covers/${deleteBookId}.jpg`);
                        await deleteObject(coverRef);
                    } catch (e) {
                        console.log('No cover to delete or error:', e);
                    }
                }

                await deleteDoc(doc(db, 'books', deleteBookId));
                closeDeleteModal();
            } catch (error) {
                console.error('Error deleting book:', error);
                alert('Error deleting book. Please try again.');
            }
        });

        // Resize image before upload
        async function resizeImage(file, maxWidth = 300, maxHeight = 450) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;

                        if (width > maxWidth || height > maxHeight) {
                            const ratio = Math.min(maxWidth / width, maxHeight / height);
                            width *= ratio;
                            height *= ratio;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(resolve, 'image/jpeg', 0.85);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Cover preview
        document.getElementById('bookCover').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('coverPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Form submit
        bookForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('bookId').value;
            const coverFile = document.getElementById('bookCover').files[0];

            const bookData = {
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                pages: parseInt(document.getElementById('bookPages').value) || null,
                rating: parseInt(document.getElementById('bookRating').value),
                series: document.getElementById('bookSeries').value || null,
                category: document.getElementById('bookCategory').value || null,
                firstEdition: document.getElementById('bookFirstEdition').value || null,
                dateRead: document.getElementById('bookDateRead').value || null,
                preview: document.getElementById('bookPreview').value || null,
                plot: document.getElementById('bookPlot').value || null
            };

            try {
                let docId = id;

                if (id) {
                    await updateDoc(doc(db, 'books', id), bookData);
                } else {
                    const docRef = await addDoc(collection(db, 'books'), bookData);
                    docId = docRef.id;
                }

                if (coverFile) {
                    const resizedBlob = await resizeImage(coverFile);
                    const coverRef = ref(storage, `covers/${docId}.jpg`);
                    await uploadBytes(coverRef, resizedBlob);
                    const coverUrl = await getDownloadURL(coverRef);
                    await updateDoc(doc(db, 'books', docId), { coverUrl });
                }

                closeBookModal();
            } catch (error) {
                console.error('Error saving book:', error);
                alert('Error saving book. Please try again.');
            }
        });

        // ============================================
        // AUTHENTICATION
        // ============================================

        signInBtn.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Sign in error:', error);
            }
        });

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Sign out error:', error);
            }
        });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            isOwner = user && user.email === OWNER_EMAIL;

            signInBtn.style.display = user ? 'none' : 'block';
            signOutBtn.style.display = user ? 'block' : 'none';
            addBtn.style.display = isOwner ? 'block' : 'none';

            renderBooks();
        });

        // ============================================
        // FIREBASE LISTENER
        // ============================================

        onSnapshot(collection(db, 'books'), (snapshot) => {
            allBooks = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            updateStats();
            applyFiltersAndSort();
        }, (error) => {
            console.error('Error fetching books:', error);
            bookListEl.innerHTML = '<div class="no-results">Error loading books. Please try again later.</div>';
        });

        // Close modals on outside click
        [textModal, bookModal, deleteModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>
