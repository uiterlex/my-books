<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Book Collection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-left h1 {
            font-size: 2rem;
            font-weight: 600;
            color: #1a1a1a;
        }

        .stats {
            color: #666;
            margin-top: 0.5rem;
        }

        .header-right {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #6366f1;
            color: white;
        }

        .btn-primary:hover {
            background: #4f46e5;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .user-info {
            font-size: 0.85rem;
            color: #666;
        }

        .book-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .book-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }

        .book-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 0.25rem;
        }

        .book-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1a1a1a;
        }

        .book-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .book-card:hover .book-actions {
            opacity: 1;
        }

        .category {
            background: #fef3c7;
            color: #92400e;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            text-transform: capitalize;
        }

        .category.thriller { background: #fee2e2; color: #991b1b; }
        .category.detective { background: #dbeafe; color: #1e40af; }
        .category.other { background: #e5e7eb; color: #374151; }

        .book-author {
            color: #666;
            margin-bottom: 0.75rem;
        }

        .book-meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .book-meta span {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: #555;
        }

        .stars {
            color: #f59e0b;
            letter-spacing: 1px;
        }

        .series {
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .book-details {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: #666;
            padding-top: 0.5rem;
            border-top: 1px solid #eee;
        }

        .book-details span {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .text-preview {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #eee;
        }

        .text-preview-row {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .text-preview-row:last-child {
            margin-bottom: 0;
        }

        .preview-label {
            font-weight: 500;
            color: #555;
            min-width: 60px;
        }

        .preview-text {
            color: #666;
            flex: 1;
        }

        .truncated {
            display: inline;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #6366f1;
            cursor: pointer;
            padding: 0.1rem 0.3rem;
            font-size: 0.85rem;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .expand-btn:hover {
            background: #eef2ff;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-weight: 600;
            color: #1a1a1a;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 1.25rem;
            color: #444;
            line-height: 1.7;
        }

        /* Form modal styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .confirm-message {
            margin: 1rem 0;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 2rem;
            color: #dc2626;
            background: #fef2f2;
            border-radius: 8px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>üìö My Book Collection</h1>
                <p class="stats" id="stats">Loading...</p>
            </div>
            <div class="header-right">
                <span class="user-info" id="user-info"></span>
                <button class="btn btn-primary hidden" id="add-btn" onclick="openAddModal()">+ Add Book</button>
                <button class="btn btn-secondary hidden" id="sign-in-btn" onclick="signIn()">Sign In</button>
                <button class="btn btn-secondary hidden" id="sign-out-btn" onclick="signOut()">Sign Out</button>
            </div>
        </header>

        <div class="book-list" id="book-list">
            <div class="loading">Loading books...</div>
        </div>
    </div>

    <!-- Text Preview Modal -->
    <div class="modal-overlay" id="text-modal" onclick="closeTextModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" id="text-modal-title">Title</span>
                <button class="modal-close" onclick="closeTextModal()">&times;</button>
            </div>
            <div class="modal-body" id="text-modal-body">
                Content
            </div>
        </div>
    </div>

    <!-- Add/Edit Book Modal -->
    <div class="modal-overlay" id="form-modal" onclick="closeFormModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" id="form-modal-title">Add Book</span>
                <button class="modal-close" onclick="closeFormModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="book-form" onsubmit="saveBook(event)">
                    <input type="hidden" id="book-id">
                    
                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="author">Author *</label>
                        <input type="text" id="author" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pages">Pages</label>
                            <input type="number" id="pages" min="1">
                        </div>
                        <div class="form-group">
                            <label for="rating">Rating</label>
                            <select id="rating">
                                <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option>
                                <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</option>
                                <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</option>
                                <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</option>
                                <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="series">Series</label>
                        <input type="text" id="series">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select id="category">
                                <option value="">-- Select --</option>
                                <option value="thriller">Thriller</option>
                                <option value="detective">Detective</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="firstEdition">First Edition (year)</label>
                            <input type="text" id="firstEdition" maxlength="4" pattern="[0-9]{4}" placeholder="2023">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="dateRead">Date Read</label>
                        <input type="month" id="dateRead">
                    </div>
                    
                    <div class="form-group">
                        <label for="preview">Preview</label>
                        <textarea id="preview" placeholder="Short teaser text..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="plot">Plot</label>
                        <textarea id="plot" placeholder="Plot summary..."></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeFormModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title">Delete Book</span>
                <button class="modal-close" onclick="closeConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="confirm-message" id="confirm-message">Are you sure you want to delete this book?</p>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, signOut as firebaseSignOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC7oDuArIH_LMQbSyKE8k1g0m3n_fa1NH8",
            authDomain: "my-books-4ef15.firebaseapp.com",
            projectId: "my-books-4ef15",
            storageBucket: "my-books-4ef15.firebasestorage.app",
            messagingSenderId: "920189621468",
            appId: "1:920189621468:web:101a4c439e8e3cbd18d019"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const OWNER_EMAIL = "uiterlex@gmail.com";

        let books = [];
        let bookToDelete = null;
        let currentUser = null;
        let isOwner = false;

        // Auth functions
        window.signIn = async function() {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Sign in failed. Please try again.');
            }
        };

        window.signOut = async function() {
            try {
                await firebaseSignOut(auth);
            } catch (error) {
                console.error('Sign out error:', error);
            }
        };

        function updateAuthUI() {
            const signInBtn = document.getElementById('sign-in-btn');
            const signOutBtn = document.getElementById('sign-out-btn');
            const addBtn = document.getElementById('add-btn');
            const userInfo = document.getElementById('user-info');

            if (currentUser) {
                signInBtn.classList.add('hidden');
                signOutBtn.classList.remove('hidden');
                userInfo.textContent = currentUser.email;
                
                if (isOwner) {
                    addBtn.classList.remove('hidden');
                }
            } else {
                signInBtn.classList.remove('hidden');
                signOutBtn.classList.add('hidden');
                addBtn.classList.add('hidden');
                userInfo.textContent = '';
            }
            
            // Re-render to show/hide edit buttons
            renderBooks(books);
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            isOwner = user && user.email === OWNER_EMAIL;
            updateAuthUI();
        });

        // Render functions
        function renderStars(rating) {
            return '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5 - rating);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const [year, month] = dateStr.split('-');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }

        function truncateText(text, maxLength = 50) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength).trim() + '...';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderBook(book) {
            const hasTextPreview = book.preview || book.plot;
            const hasDetails = book.dateRead || book.firstEdition;
            
            return `
                <article class="book-card" data-book-id="${book.id}">
                    <div class="book-header">
                        <h2 class="book-title">${escapeHtml(book.title)}</h2>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${book.category ? `<span class="category ${book.category}">${escapeHtml(book.category)}</span>` : ''}
                            ${isOwner ? `
                                <div class="book-actions">
                                    <button class="btn btn-secondary btn-small" onclick="openEditModal('${book.id}')">‚úèÔ∏è</button>
                                    <button class="btn btn-danger btn-small" onclick="openDeleteModal('${book.id}', '${escapeHtml(book.title)}')">üóëÔ∏è</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <p class="book-author">${escapeHtml(book.author)}</p>
                    <div class="book-meta">
                        <span class="stars">${renderStars(book.rating || 0)}</span>
                        <span>üìÑ ${book.pages || 0} pages</span>
                        ${book.series ? `<span class="series">${escapeHtml(book.series)}</span>` : ''}
                    </div>
                    ${hasDetails ? `
                        <div class="book-details">
                            ${book.dateRead ? `<span>üìÖ Read: ${formatDate(book.dateRead)}</span>` : ''}
                            ${book.firstEdition ? `<span>üìñ First edition: ${escapeHtml(book.firstEdition)}</span>` : ''}
                        </div>
                    ` : ''}
                    ${hasTextPreview ? `
                        <div class="text-preview">
                            ${book.preview ? `
                                <div class="text-preview-row">
                                    <span class="preview-label">Preview:</span>
                                    <span class="preview-text">
                                        <span class="truncated">${escapeHtml(truncateText(book.preview))}</span>
                                        <button class="expand-btn" data-title="Preview: ${escapeHtml(book.title)}" data-content="${escapeHtml(book.preview)}">‚ÑπÔ∏è</button>
                                    </span>
                                </div>
                            ` : ''}
                            ${book.plot ? `
                                <div class="text-preview-row">
                                    <span class="preview-label">Plot:</span>
                                    <span class="preview-text">
                                        <span class="truncated">${escapeHtml(truncateText(book.plot))}</span>
                                        <button class="expand-btn" data-title="Plot: ${escapeHtml(book.title)}" data-content="${escapeHtml(book.plot)}">‚ÑπÔ∏è</button>
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </article>
            `;
        }

        function renderStats(books) {
            const totalBooks = books.length;
            const totalPages = books.reduce((sum, book) => sum + (book.pages || 0), 0);
            return `${totalBooks} books read ¬∑ ${totalPages.toLocaleString()} pages`;
        }

        function renderBooks(bookList) {
            const bookListEl = document.getElementById('book-list');
            const stats = document.getElementById('stats');
            
            if (bookList.length === 0) {
                bookListEl.innerHTML = '<div class="loading">No books in collection yet.</div>';
                stats.textContent = '0 books read';
                return;
            }

            // Sort by date read (newest first)
            const sortedBooks = [...bookList].sort((a, b) => (b.dateRead || '').localeCompare(a.dateRead || ''));
            
            bookListEl.innerHTML = sortedBooks.map(renderBook).join('');
            stats.textContent = renderStats(bookList);

            // Add event listeners to expand buttons
            document.querySelectorAll('.expand-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    showTextModal(btn.dataset.title, btn.dataset.content);
                });
            });
        }

        // Text modal functions
        function showTextModal(title, content) {
            document.getElementById('text-modal-title').textContent = title;
            document.getElementById('text-modal-body').textContent = content;
            document.getElementById('text-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        window.closeTextModal = function(event) {
            if (!event || event.target === document.getElementById('text-modal')) {
                document.getElementById('text-modal').classList.remove('active');
                document.body.style.overflow = '';
            }
        };

        // Form modal functions
        window.openAddModal = function() {
            document.getElementById('form-modal-title').textContent = 'Add Book';
            document.getElementById('book-form').reset();
            document.getElementById('book-id').value = '';
            document.getElementById('form-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.openEditModal = function(bookId) {
            const book = books.find(b => b.id === bookId);
            if (!book) return;

            document.getElementById('form-modal-title').textContent = 'Edit Book';
            document.getElementById('book-id').value = bookId;
            document.getElementById('title').value = book.title || '';
            document.getElementById('author').value = book.author || '';
            document.getElementById('pages').value = book.pages || '';
            document.getElementById('rating').value = book.rating || 5;
            document.getElementById('series').value = book.series || '';
            document.getElementById('category').value = book.category || '';
            document.getElementById('firstEdition').value = book.firstEdition || '';
            document.getElementById('dateRead').value = book.dateRead || '';
            document.getElementById('preview').value = book.preview || '';
            document.getElementById('plot').value = book.plot || '';

            document.getElementById('form-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.closeFormModal = function(event) {
            if (!event || event.target === document.getElementById('form-modal')) {
                document.getElementById('form-modal').classList.remove('active');
                document.body.style.overflow = '';
            }
        };

        window.saveBook = async function(event) {
            event.preventDefault();
            
            const bookId = document.getElementById('book-id').value;
            const bookData = {
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                pages: parseInt(document.getElementById('pages').value) || 0,
                rating: parseInt(document.getElementById('rating').value),
                series: document.getElementById('series').value,
                category: document.getElementById('category').value,
                firstEdition: document.getElementById('firstEdition').value,
                dateRead: document.getElementById('dateRead').value,
                preview: document.getElementById('preview').value,
                plot: document.getElementById('plot').value
            };

            try {
                if (bookId) {
                    await updateDoc(doc(db, 'books', bookId), bookData);
                } else {
                    await addDoc(collection(db, 'books'), bookData);
                }
                closeFormModal();
            } catch (error) {
                console.error('Error saving book:', error);
                alert('Failed to save book. Please try again.');
            }
        };

        // Delete modal functions
        window.openDeleteModal = function(bookId, title) {
            bookToDelete = bookId;
            document.getElementById('confirm-message').textContent = `Are you sure you want to delete "${title}"?`;
            document.getElementById('confirm-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.closeConfirmModal = function() {
            document.getElementById('confirm-modal').classList.remove('active');
            document.body.style.overflow = '';
            bookToDelete = null;
        };

        window.confirmDelete = async function() {
            if (!bookToDelete) return;

            try {
                await deleteDoc(doc(db, 'books', bookToDelete));
                closeConfirmModal();
            } catch (error) {
                console.error('Error deleting book:', error);
                alert('Failed to delete book. Please try again.');
            }
        };

        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTextModal();
                closeFormModal();
                closeConfirmModal();
            }
        });

        // Listen to Firestore changes
        const booksQuery = query(collection(db, 'books'), orderBy('dateRead', 'desc'));
        onSnapshot(booksQuery, (snapshot) => {
            books = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            renderBooks(books);
        }, (error) => {
            console.error('Error loading books:', error);
            document.getElementById('book-list').innerHTML = '<div class="error">Failed to load books. Please refresh the page.</div>';
        });
    </script>
</body>
</html>
